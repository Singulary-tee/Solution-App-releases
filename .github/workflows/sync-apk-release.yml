name: Sync APK Release

on:
  # Triggered automatically from private repos via repository_dispatch
  repository_dispatch:
    types: [apk-release]

  # Manual trigger for one-off syncs
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source private repo'
        required: true
        type: string
      release_tag:
        description: 'Release tag in the source repo'
        required: true
        type: string
      app_name:
        description: 'App name used for organizing APKs'
        required: true
        type: string

jobs:
  sync-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Resolve inputs
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "source_repo=${{ github.event.client_payload.source_repo }}" >> "$GITHUB_OUTPUT"
            echo "release_tag=${{ github.event.client_payload.release_tag }}"  >> "$GITHUB_OUTPUT"
            echo "app_name=${{ github.event.client_payload.app_name }}"        >> "$GITHUB_OUTPUT"
          else
            echo "source_repo=${{ inputs.source_repo }}" >> "$GITHUB_OUTPUT"
            echo "release_tag=${{ inputs.release_tag }}"  >> "$GITHUB_OUTPUT"
            echo "app_name=${{ inputs.app_name }}"        >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK assets from private repo release
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          mkdir -p apks
          SOURCE_REPO="${{ steps.vars.outputs.source_repo }}"
          RELEASE_TAG="${{ steps.vars.outputs.release_tag }}"

          echo "Fetching release assets from ${SOURCE_REPO}@${RELEASE_TAG} ..."

          # Download only .apk files from the release
          gh release download "$RELEASE_TAG" \
            --repo "$SOURCE_REPO" \
            --pattern "*.apk" \
            --dir apks

          echo "Downloaded APKs:"
          ls -lh apks/

          # Fail early if no APKs were downloaded
          APK_COUNT=$(ls apks/*.apk 2>/dev/null | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "ERROR: No APK files found in the release '${RELEASE_TAG}' of '${SOURCE_REPO}'."
            exit 1
          fi
          echo "Found ${APK_COUNT} APK file(s) to publish."

      - name: Create or update release in this public repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          RELEASE_TAG="${{ steps.vars.outputs.release_tag }}"
          PUBLIC_TAG="${APP_NAME}-${RELEASE_TAG}"

          # Build a release title and body
          RELEASE_TITLE="${APP_NAME} ${RELEASE_TAG}"
          RELEASE_NOTES="APK release for **${APP_NAME}** \`${RELEASE_TAG}\`."

          echo "Publishing release '${PUBLIC_TAG}' ..."

          # Create the release if it doesn't exist yet; ignore error if it already does
          gh release create "$PUBLIC_TAG" \
            --repo "${{ github.repository }}" \
            --title "$RELEASE_TITLE" \
            --notes "$RELEASE_NOTES" 2>/dev/null || true

          # Upload (or overwrite) all downloaded APKs
          gh release upload "$PUBLIC_TAG" apks/*.apk \
            --repo "${{ github.repository }}" \
            --clobber

          echo "Release published: https://github.com/${{ github.repository }}/releases/tag/${PUBLIC_TAG}"

      - name: Update releases and README
        run: |
          APP_NAME="${{ steps.vars.outputs.app_name }}"
          VERSION="${{ steps.vars.outputs.release_tag }}"
          DATE=$(LC_TIME=C date +'%B %d, %Y')
          PUBLIC_TAG="${APP_NAME}-${VERSION}"
          DOWNLOAD="https://github.com/${{ github.repository }}/releases/download/${PUBLIC_TAG}/${APP_NAME}.apk"

          # Initialize releases.json if it doesn't exist
          if [ ! -f releases.json ]; then
            echo '{}' > releases.json
          fi

          # Update releases.json for this specific app only
          jq --arg app "$APP_NAME" \
             --arg version "$VERSION" \
             --arg date "$DATE" \
             --arg url "$DOWNLOAD" \
             '.[$app] = {"version": $version, "date": $date, "download": $url}' \
             releases.json > releases.tmp && mv releases.tmp releases.json

          # Regenerate README from releases.json
          {
            echo "# Releases"
            echo ""
            echo "| App | Version | Released | Download |"
            echo "|---|---|---|---|"
            jq -r 'to_entries[] | "| \(.key) | \(.value.version) | \(.value.date) | [Download APK](\(.value.download)) |"' releases.json
            echo ""
            echo "---"
            echo '<a href="https://ko-fi.com/your_solution">Support</a>'
          } > README.md

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add releases.json README.md
          git diff --staged --quiet || git commit -m "Update ${APP_NAME} to ${VERSION}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
